## 모노레포와 터보레포

다수의 프로젝트와 라이브러리를 함께 관리해야 하는 상황에서 다음과 같은 고민이 생길 수 있다.

- 어떻게 해야 개발 환경 구축을 매번 반복적으로 수행하지 않을 수 있을까?
- 설치, 빌드, 테스트, 배포까지 비슷한 형태로 이뤄지는 배포 전략을 일관적으로 수행할 수 있을까?
- 여러 프로젝트에서 공유되는 모듈은 어떻게 효율적으로 유지보수할까?
- 프로젝트에 참여하는 개발자들이 원활하게 협업 가능한 환경을 어떻게 구축할 수 있을까?
- 패키지들의 의존성을 어떻게 체계적으로 관리할 수 있을까?
- 의존 관계에 있는 모든 패키지의 테스트를 어떻게 통합적으로 관리할까?
- 중복된 코드를 작성하지 않고도 어떻게 기능을 다수의 패키지에서 재사용할 수 있을까?

### 멀티레포

- 여러 개의 패키지와 저장소를 1:1로 매핑해서 각 저장소에 패키지를 관리하는 레포 관리 방식
- 각 패키지별로 저장소를 하나씩 생성해서 코드를 관리하는 형태

#### 멀티레포의 특징

- 패키지와 저장소가 1:1 매핑
- 저장소라는 물리적 단위로 분리 → 설치 방법이나 구성이 각 패키지마다 상이할 수 있음
- 패키지를 어떤 의존 관계 없이 독립적으로 관리 가능

#### 멀티레포의 장점

- 저장소마다 빌드를 병렬로 진행 가능 → 빠른 빌드 속도
- 의존성의 버전을 독립적으로 관리 가능
- 저장소별 소유자(owner)를 지정해 패키지를 자율적으로 관리 가능 → 보안 및 권한 관리 측면에서 용이
- 특정 패키지에서 발생한 문제가 전체 시스템에 영향을 미치지 않기 떄문에 문제 해결에 대한 부담 감소
- 독립적으로 개발이 진행되므로 여러 개의 프로젝트를 병렬로 처리 시 빠른 개발 속도

#### 멀티레포의 단점

- 중복된 코드 및 환경 구성을 반복적으로 진행해야 함
- 이슈나 변경로그가 분산되어 유지보수 시 관리 포인트 증가
- 패키지 간 의존성 관리의 어려움
- 의존 관계가 복잡한 패키지들을 순서대로 배포하려면 추가적인 관리와 노력 필요 → 배포 복잡도 상승
- 공통 의존성 관리의 어려움

### 모노레포

- 여러 프로젝트 혹은 패키지를 단일 저장소에서 관리하는 레포 관리 방식

#### 모노레포의 특징

- 모든 코드가 하나의 저장소에 위치 → 설치나 구성과 같은 공통 항목 단일화
- 패키지 간 의존 관계가 하나의 저장소에서 이뤄짐
- 각 패키지들의 소유자와 협력해야 하는 구조 → 협력하는 개발 문화가 기반이 되어야 함

#### 모노레포의 장점

- 프로젝트 간 의존성을 파악하고 관리하기 용이
- 단일 저장소 → 이슈 추적 및 로그 관리 용이
- 패키지 간 의존성을 설정하기 쉬워 공유가 용이
- 전체 패키지에 영향이 갈 수 있는 수정을 단 한 번의 변경만으로 해결 가능
- 모노레포 도구들을 통해 공통으로 포함된 의존성 관리 용이 → 더 적은 노력으로 시스템 일관성 확보

#### 모노레포의 단점

- 상대적으로 느린 CI/CD 속도 → 변경된 부분만 테스트하거나 빌드할 수 있도록 최적화 필요
- 코드베이스의 규모가 커지면 깃 저장소 관리가 느려질 수 있음 → clone, pull 동작에 영향
- 오픈소스의 경우, 기여자가 반영한 수정 사항이 다른 패키지에 어떤 영향을 미치는지 파악하기 어려움
- 모든 팀이 같은 레포에 접근해야 하기 때문에 까다로운 관리와 통제 발생
- 멀티레포보다 상대적으로 복잡한 도구(빌드, 테스트, 린팅 등) 설정

### 언제 모노레포를 선택해야 할까?

- 패키지 간 버전의 일관성을 유지해야 하는지?
- 의존성 관리 및 수정 영향 범위가 어떻게 되는지?
- 일관된 프로젝트 환경을 고수해야 하는지?
- 협업이 얼마나 필요한지?

모노레포를 도입할 때는 목표로 하는 프로젝트의 성격, 개발 환경 및 담당할 개발 조직의 문화를 항상 최우선으로 고려해야 한다. 즉, “모노레포를 도입했을 때 구성원들의 생산성이 향상되는가”에 중점을 두자.

### npm 워크스페이스(workspace)

- Node.js 프로젝트에서 모노레포 구성 가능한 npm 기능
- npm v7부터 지원

#### npm 워크스페이스 사용법

```json
// package.json
{
  "name": "my-project",
  "private": true,
  "wrokspaces": ["packages/*"]
}
```

`!` private 필드는 true로 설정 권장 → 최상위 프로젝트가 실수로 배포되는 것을 방지

**워크스페이스에 package 추가**

```bash
$ npm init --workspace=packages/a-package --workspace=packages/b-package
```

`!` —workspace 인자로 생성할 패키지명에 실제 경로를 모두 작성 필요

**워크스페이스 동작 방식**

npm 워크스페이스는 여러 패키지를 관리할 때 각 워크스페이스 패키지 간 의존성을 심볼릭 링크로 연결해 로컬 참조를 효율적으로 처리한다. 심볼릭 링크가 없을 경우 로컬 파일 시스템에 동기화해야 하는 패키지에 다른 패키지의 참조를 추가하려면 수동으로 npm 링크를 생성하고 연결해야 한다.

이러한 심볼릭 링크 구조 덕분에 npm 워크스페이스는 모노레포 환경에서 패키지 간 자동 참조 및 의존성의 중복을 줄여주어 복잡한 프로젝트를 관리하는 데 매우 유용하다.

> 실제 배포 시에는 패키지들이 외부에서 제대로 동작하게 하려면 의존성에 실제 버전 번호를 명시해야 함
> → npm 자체는 패키지 간 의존성을 배포 시에 자동으로 처리하지 않으므로 개발자가 수동으로 관리 필요
> → 따라서 개발자가 직접 관리하기 보다는 버전 관리 도구를 활용할 것을 권장 (changeset)

#### 워크스페이스에서 실행 스크립트 호출 방법

특정 패키지의 실행 스크립트 호출

```bash
$ npm run test --workspace=a-package
```

모든 패키지의 실행 스크립트 호출 (해당 실행 스크립트가 모든 패키지에 있어야 함)

- `!` 실행 스크립트가 있는 일부 워크스페이스에만 호출하고 싶다면 `--if-present` 옵션 사용

```bash
$ npm run test --workspaces
```

### 모노레포를 구성하는 도구, 터보레포

### 터보레포 프로젝트 생성하기

```bash
# 직접 생성
$ npm install turbo --save-dev

# cli로 생성
$ npx create-turbo@latest
```

### turbo.json

```bash
{
  "$schema": "https://turborepo.com/schema.json",
  "ui": "tui",
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "inputs": ["$TURBO_DEFAULT$", ".env*"],
      "outputs": [".next/**", "!.next/cache/**"]
    },
    "lint": {
      "dependsOn": ["^lint"]
    },
    "check-types": {
      "dependsOn": ["^check-types"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    }
  }
}
```

- 터보레포에서 중요한 구성 파일로 프로젝트의 빌드, 테스트, 린트 등의 모노레포상의 모든 작업을 어떻게 병렬로 처리하고 캐싱할지를 정의하는 메타데이터를 담은 파일
- 병렬로 작업을 실행하면서 작업의 결과를 캐싱 → turbo.json에서 설정

#### 터보레포의 작업 단위

- 주로 스크립트나 명령어의 단위로 결정
- 기본적으로 `turbo run`으로 시작하는 스크립트를 실행 단위로 사용
- 즉, 각 패키지별로 정의된 npm 스크립트가 작업의 단위가 되는 형태
- `$ turbo run lint test build`처럼 한 번에 다수의 작업도 실행 가능 (병렬 실행)
- `!` `turbo run`으로 입력한 스크립트는 반드시 turbo.json의 `tasks` 필드에 정의되어 있어야 함

```bash
{
  "name": "@repo/ui",
  "scripts": {
	  "build": "turbo run build",
    "lint": "turbo run lint",
    "test": "turbo run test"
  }
}
```
