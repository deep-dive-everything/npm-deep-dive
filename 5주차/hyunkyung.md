# 3장

## 3.1 npm의 문제점과 한계

### 3.1.1 유령 의존성

- 유령 의존성이란 package.json의 dependencies나 devDependencies에 명시되지 않은 의존성을 실제 코드에서 사용 가능한 경우를 의미
- 유령 의존성으로 생겨나는 문제
  - 의도치않은 제거가 이루어져 패키지 사용이 불가능해질 수 있음
  - 중첩된 구조가 필요: 동일한 패키지라도 서로 다른 버전이 필요할 때가 있고 이때 결국 중첩된 구조로 설치가 되어야 함

### 3.1.2 디스크 I/O 부하

- node_modules 폴더 구조가 복잡해지면 탐색 시간이 길어지며 디스크 I/O 부하가 발생할 수 있음

### 3.1.3 너무 거대한 node_modules

- node_modules는 작성한 코드보다 훨씬 더 큰 용량을 차지

### 3.1.4 변경에 취약한 락 파일

- package-lock.json은 npm이 특정 시점의 package.json을 기준으로 의존성 트리를 저장해서 의존성에 업데이트가 발생하더라도 동일한 설치 환경을 보장하기 위해 생성된 파일
- 목적
  - 팀원 배포, CI 환경이 동일한 의존성 트리를 설치할 수 있도록 보장
  - node_modules 폴더를 커밋하지 않고도 의존성을 재현 가능하게 함
  - 소스 버전 관리 도구에서 변경사항을 확인할 수 있는 Diff 제공
  - npm이 이전에 설치된 패키지의 메타데이터 확인을 건너뛰어 설치 속도를 최적화
  - package.json을 매번 읽지 않아도 되어 성능을 개선
- 하지만 Package-lock.json은 의존성의 규모에 따라 몇십줄에서 수 MB에 이를 수 있으며, 이로 인해 변경사항을 확인하기가 매우 어려움

## 3.2 yarn: 신속하고 안정적인 패키지 관리를 위한 패키지 관리자

### 3.2.1 yarn 소개와 역사

#### 3.2.1.1 yarn의 탄생

- yarn이 등장할 당시 npm 패키지 매니저를 이용하여 패키지를 설치하면 Node_modules는 설치 환경과 상황에 따라 구조가 달랐음
- 외에도 가졌던 한계
  - 샌드박스 환경, 즉 인터넷이 없는 환경에서는 npm을 사용할 수 없음
  - 당시 의존성을 완전히 고정하기 위해 shrinkwrap이라는 명령어가 있었지만 이를 개발자가 의식적으로 실행하지않으면 누락되기 쉬웠음
  - 단일 의존성을 업데이트해도 관련되지 않은 의존성까지 유의적 버전 규칙을 기반으로 함께 업데이트되는 문제가 있었음

#### 3.2.1.2 yarn@2의 등장과 논란

- 버전 업데이트를 하며 그 변경점이 너무 커서 논란이 있었음
  - npm install -g yarn을 지원하지 않게 변경되어버림
  - pnp 모드가 기본값으로 설정되어 사용자의 로컬환경(에디터, 명령어)이 이에 대응되지 않아 불편을 초래
  - node_modules를 직접 참조하던 일부 대형 패키지(flow, react native)를 사용할 수 없게됨

#### 3.2.1.3 현재 yarn berry@4.x

- 3.x와 4.x에서는 사용에 큰 영향을 미칠 수 있는 변경을 최대한 자제하여 안정적으로 사용자층 확장

### 3.2.2 특징

#### 3.2.2.1 Yarn.lock

- yarn.lock은 여러 기기에서 실행할 때 동일한 의존성을 설치할 수 있도록 Package.json보다 더 정확한 의존성 정보를 기록 -> 버전 범위가 불명확한 package.json의 한계를 보완하기 위해 설계됨
- yarn.lock파일과 package-lock.json의 차이
  - yarn.lock 파일은 사람이 읽기 쉬우며 diff를 쉽게 파악할 수 있는 구조 + 빠른 파싱을 위한 구조
  - 패키지 설치에 yarn 자체 레지스트리 주소를 사용함(Npm 레지스트리의 설치속도가 느렸으나 현재는 개선됨)

#### 3.2.2.2 plug n play

- plug n play 살펴보기
  - .pnp.cjs 파일을 통해 실행
  - yarn의 pnp는 require가 모듈을 찾을 때 사용하는 모듈 해석 시스템(module)을 오버라이드하여 node_modules 폴더 탐색 대신 자신이 관리하는 패키지 경로에서만 검색하도록 함
    - 탐색을 구체적 경로로 한정하여 안정적이고 빠르게 패키지를 탐색할 수 있게 함
  - 한번 다운로드한 패키지는 글로벌 캐시 폴더에 저장하여 더 빠르게 설치될 수 있게 함
    - 디스크 공간도 절약 가능
- zero install
  - 레지스트리를 방문하지 않고도 필요한 의존성을 설치할 수 있는 옵션
  - .yarn 폴더 전체를 버전 관리 시스템에 포함하여 pull할때 의존성을 가져오게됨

#### 3.2.2.4 플러그인 시스템

- 사용자가 원하는 작업을 수행할 수 있는 API를 추가할 수 있음
- 플러그인을 통해 가능한 작업

  - 의존성 버전 결정 방식 변경: ^와 같은 의존성 버전 문법을 수정해 특정 패키지가 설치되는 정확한 버전을 임의로 변경할 수 있음
  - 패키지 fetcher: 패키지 데이터를 얻는 방식을 결정할 수 있음
  - 새로운 명령어 추가: yarn에 새로운 명령어를 추가해서 yarn api를 사용하거나 완전히 새로운 동작 추가
  - 새로운 이벤트 등록: yarn의 생명주기 동안 특별한 로직을 추가

- 대표적인 Yarn 플러그인
  - yarn-plugin-outdated: 의존성중 업데이트가 필요한 패키지를 찾기위한 플러그인
  - Yarn-plugin-engines: 패키지 실행에 필요한 node.js 버전을 점검할 수 있음
  - yarn-plugin-license: 현재 프로젝트가 의존하는 의존성의 라이선스를 한눈에 확인
  - yarn-plugin-nolyfill: node_modules를 최적화

#### 3.2.2.5 yarn이 생성하는 파일과 디렉터리

- `.yarn/cache`: 오프라인 설치를 활성화했을 때 생성되는 폴더
- `.yarn/install-state.gz`: yarn의 최적화를 위한 파일. 현재 프로젝트의 정확한 상태를 저장한 다음 이를 바탕으로 다음 명령어를 빠르게 실행하기 위해 생성됨
- `.yarn/patches`: yarn patch의 정보를 저장해두는 파일
  - yarn patch는 node_modules에 있는 패키지를 직접 수정할 수 있는 패치 제공
