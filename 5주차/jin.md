# NPM DEEP DIVE

# 3장. npm 대항마 yarn과 pnpm


`npm` 이 나쁘다는 것이 아니라 각각의 장단점을 알고 선택하자!

## 1. `npm`의 문제점과 한계

배경 : 프로젝트 규모가 커지고 다양한 환경에 대응해야하는 필요성 대두

문제

1. 유령 의존성 (Phantom Dependency)
    
    `npm`의 평탄화된 `node_modules` 구조 때문에 의존성 트리가 꼬이면 실제로 `node_modules` 폴더에는 존재하지만 `package.json`에는 명시되어 있지 않은 의존성을 실제 코드에서 사용 가능해지면서 안정성을 무너트림
    
    1. 패키지 변경에 따라 사용 불가능
        1. B에 의존성을 가지던 A,C가 버전업을 하며 B 의존성 제거 ⇒ 간접적으로 B를 사용하는 컴포넌트 있을 수 있음
    2. 여전히 중첩된 구조 필요
        1. 동일한 패키지 서로 다른 버전 필요 ⇒ 크기가 커질 수록 호환성 유지가 어려움
2. 디스크 IO
    
    `Node.js` 의존성을 찾기 위해 현재 디렉터리부터 시작해 상위 디렉터리로 이동하면서 `node_modules` 폴더를 탐색하는 방식 ⇒ 탐색 경로가 길어질수록 디스크에 부담
    
3. 너무 거대한 node_modules
    
    `npm`은 패키지를 독립적으로 설치하기 때문에, 동일한 의존성이 여러 번 중복 설치로 인한 문제
    
    1. 불필요한 디스크 공간 사용
    2. 빌드 시간 증가
    3. 유효성 검사와 성능 저하
4. 변경에 취약한 락 파일
    
    `npm`의 `package-lock.json` 파일은 프로젝트의 특정 시점에 의존성 트리를 저장하여 언제나 협업에서 동일한 설치 환경을 보장하기 위해 생성된 파일이지만 목적과 장점이 지켜지지 않음
    
    1. `git` 의 `diff` 용량이 너무 커서 조회가 어려움 ⇒ 변경 사항 확인이 어려워서 개발자가 `node_modules` 에 세밀한 통제를 잃음

## 2. yarn : 신속하고 안정적인 패키지 관리를 위한 패키지 관리자

`yarn`은 2016년 메타에서 개발 및 공개한 자바스크립트 패키지 관리자로 빠른 속도와 안정성을 주요 특징으로 가지며 대규모 프로젝트, 모노레포 환경에서 특히 유용하다는 평가를 받고 있음

1. yarn 소개와 역사
    
    yet another resource negotiator

    
    배경 : yarn이 본 npm의 한계
    
    1. 인터넷이 없는 환경에서 npm 사용 불가
    2. 의존성 고정을 위한 명령어가 있지만 개발자가 의식적으로 실행해야 함
    3. 단일 의존성을 업데이트해도 관련되지 않은 의존성까지 함께 업데이트 되는 문제
    
    프로젝트 운영 방식에 신경을 쓰며 npm을 잘 쓰려고 해봤으나 근본적인 문제 해결을 위해 자체 패키지 관리자를 구현하는 편이 더 낫다고 판단
    
2. yarn@2의 등장과 논란
    
    빠른 속도로 많은 사랑을 받던 1.x와 달리 2.0은 극적인 변화로 인해 논란
    
    - pnp 모드 기본값 설정
        
        `node_modules` 의 모든 패키지를 압축된 zip파일로 관리하는 방식
        
        `Node.js` 는 압축 파일을 직접 일을 수 없어서 별도 명령어 실행 필요
        
        `node_modules` 참조하던 대형 패키지 사용 불가
        
    
    너무 큰 변화로 인해 yarn-classic과 아예 다른 패키지 매니저로 생각해야한다는 의견과 혼란을 야기
    
3. 현재 yarn berry@4.x
    
    3,4에서는 사용에 큰 영향을 미칠 수 있는 변경을 최대한 자제
    

---

1. yarn 특징
    1. `yarn.lock` 파일로 일관된 의존성 관리
    - 자체적인 포맷 사용
        - 사람이 읽기 쉽고 diff를 쉽게 확인 가능하고 빠르게 파싱할 수 있도록
        - 레지스트리 주소 ⇒ 속도 빨라짐
            - 오프라인 모드 강화
            - 캐시만으로 빌드 가능
    
    b. PnP (Plug n Play)
    
    패키지 설치 시에 node_modules에 저장되는 것이 아니라 캐시 파일에 의존성 정보가 저장이 되고 의존성 정보가 zip으로 저장이 되면서 동적으로 참조
    
    - 기존의 트리 형태에서 벗어나기 때문에 검색 속도 증가 및 유령 의존성 문제 해결
    - 단점
        1. .pnp.cjs 파일도 버전관리를 해야한다는 점
        2. 모든 명령어 yarn으로 실행
        3. node_modules를 참조하는 방식에서는 불편함
        4. ide에서 별도 설정 필요
    
    c. 오프라인 설치 (zero install)
    
    레지스트리를 방문하지 않고도 의존성을 설치할 수 있는 옵션
    
    - 장점
        
        폐쇄적인 환경에서 사용 가능, 향상된 가능성
        
        더 빠른 설치 속도, 각 버전별 환경을 쉽게 재현 가능
        
    - 단점
        
        저장소 크기 제한
        
    
    d. 플러그인 시스템 
    
    기본적인 yarn 동작 외에도 사용자가 원하는 작업을 수행할 수 있는 API를 추가할 수 있음
    
    - 의존성 버전 결정 방식 변경
    - 패키지 fetcher
    - 새로운 명령어, 이벤트 추가
    - [토스 예시](https://www.youtube.com/watch?v=E7jdKomaqjI)
    
    e. 생성하는 파일과 디렉터리
    
    - .yarn/cache : 오프라인 설치 활성화 시 생성되는 폴더
    - .yarn/install-state.gz : yarn 최적화를 위한 파일
    - .yarn/patches : yarn patch 정보를 저장해두는 파일
        - 특정 패키지를 직접 수정할 수 있는 패치
    - .yarn/plugins : 앞에서 소개했던 플러그인 목록 저장…
